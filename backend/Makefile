.PHONY: all clean
.SUFFIXES:

# LESS source and destination directories
LESSSRC=static/less/src
LESSDIST=static/less/dist

# LESS compiler and its settings
LESSC=node_modules/less/bin/lessc
LESSFLAGS=--autoprefix='> 5%'

# All the LESS source code.
LESSFILES=$(shell find $(LESSSRC) -name '*.less' -type f)
# The Makefile dependency fragments generated by lessc.
LESSDEPFILES=$(patsubst %,%.d,$(LESSFILES))
# The input LESS files that we're actually interested in.
LESSSRCFILES=$(LESSSRC)/style.less
# The output CSS files.
LESSDISTFILES=$(patsubst $(LESSSRC)/%.less,$(LESSDIST)/%.min.css,$(LESSSRCFILES))

# CSS compressor and mangler
CSS_UGLY=node_modules/uglifycss/uglifycss

all: $(LESSDIST)

$(LESSDIST): $(LESSDEPFILES) $(LESSDISTFILES)

# Generic rule for building a depfile for a LESS file.
%.less.d: %.less
	$(LESSC) -M $(LESSFLAGS) $< $(patsubst $(LESSSRC)/%.less,$(LESSDIST)/%.css,$<) > $<.d
	rm $(patsubst $(LESSSRC)/%.less,$(LESSDIST)/%.css,$<)

# Rule for transforming LESS into CSS
$(LESSDIST)/%.css: $(LESSSRC)/%.less
	$(LESSC) $(LESSFLAGS) $< $@

%.min.css: %.css
	$(CSS_UGLY) $< > $@

# Inject the dependency files into this makefile.
-include $(LESSDEPFILES)

clean:
	-rm $(LESSDIST)/*.css
	-rm $(LESSSRC)/*.d

dependencies:
	bower install
	npm install
